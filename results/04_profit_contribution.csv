WITH ingredient_unit_cost AS (
    SELECT
        ingredient,
        (CAST(bulk_price AS REAL) / bulk_qty) / conversion_to_oz AS cost_per_oz
    FROM ingredient_cost
),
menu_item_cost AS (
    SELECT
        bom.menu_id,
        SUM(bom.qty * iuc.cost_per_oz) AS cost_per_item
    FROM bill_of_materials bom
    JOIN ingredient_unit_cost iuc
        ON bom.ingredient = iuc.ingredient
    GROUP BY bom.menu_id
)
SELECT
    m.name AS menu_item,
    m.menu_price,
    ROUND(mic.cost_per_item, 2) AS cost_per_item,
    ROUND(m.menu_price - mic.cost_per_item, 2) AS gross_profit_per_item,
    SUM(mi.quantity) AS total_quantity_sold,
    ROUND((m.menu_price - mic.cost_per_item) * SUM(mi.quantity), 2) AS total_profit_contribution
FROM menu_id m
JOIN menu_item_cost mic ON m.menu_id = mic.menu_id
LEFT JOIN menu_items mi ON m.name = mi.food_item
GROUP BY m.menu_id, m.name, m.menu_price, mic.cost_per_item
ORDER BY total_profit_contribution DESC;
